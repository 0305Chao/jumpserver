{% extends '_base_list.html' %}
{% load i18n %}
{% load static %}
{% load common_tags %}
{% block custom_head_css_js %}
    <link href="{% static "css/plugins/footable/footable.core.css" %}" rel="stylesheet">
    <link href="{% static 'css/plugins/datepicker/datepicker3.css' %}" rel="stylesheet">
    <link href="{% static 'css/plugins/select2/select2.min.css' %}" rel="stylesheet">
    <script src="{% static 'js/plugins/select2/select2.full.min.js' %}"></script>
    <style>
        #search_btn {
            margin-bottom: 0;
        }
    </style>
{% endblock %}

{% block content_left_head %}
{% endblock %}

{% block table_search %}
    <form id="search_form" method="get" action="" class="pull-right form-inline" style="padding-bottom: 8px">
        <div class="input-group">
            <input type="text" class="form-control input-sm" name="command" placeholder="{% trans 'Command' %}" value="{{ command }}">
        </div>
        <div class="input-group">
            <div class="input-group-btn">
                <button id='search_btn' type="submit" class="btn btn-sm btn-primary">
                    {% trans 'Search' %}
                </button>
            </div>
        </div>
    </form>
{% endblock %}
{% block table_container %}
    <table class="footable table table-stripped table-bordered toggle-arrow-tiny" data-page="false" >
        <thead>
        <tr>
            <th data-toggle="true">ID</th>
            <th>{% trans 'Command' %}</th>
            <th>{% trans 'Is Enabled' %}</th>
            <th>{% trans 'Action' %}</th>
        </tr>
        </thead>
        <tbody>
        {% for command in command_blacklist %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td><p id="p-{{command.id}}">{{ command.command }}</p>
                <input id='cmd-{{command.id}}' value="{{command.command}}" hidden></td>
            <td><p id="pp-{{command.id}}">{{ command.is_enabled }}</p>
                <input id='check-{{command.id}}' type="checkbox" checked="{{command.is_enabled}}" hidden>
            </td>
            <td>
                <button id='edit-{{command.id}}' type="edit" data-id="{{command.id}}">{% trans 'Edit' %}</button>
                <button id='delete-{{command.id}}' type="delete" data-id="{{command.id}}" hidden>{% trans 'Delete' %}</button>
                <button id='save-{{command.id}}' type="save" data-id="{{command.id}}" hidden>{% trans 'Save' %}</button>
                <button id='cancel-{{command.id}}' type="cancel" data-id="{{command.id}}"hidden>{% trans 'Cancel' %}</button>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <div id="actions" class="">
        <div class="input-group">
            <select class="form-control m-b" style="width: auto" id="slct_bulk_update">
                <option value="export">{% trans 'Export command' %}</option>
            </select>
            <div class="input-group-btn pull-left" style="padding-left: 5px;">
                <button id='btn_bulk_update' style="height: 32px;"  class="btn btn-sm btn-primary">
                    {% trans 'Submit' %}
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_foot_js %}
<script src="{% static 'js/plugins/footable/footable.all.min.js' %}"></script>
<script src="{% static 'js/plugins/datepicker/bootstrap-datepicker.js' %}"></script>
<script>
$(document).ready(function () {
    $('.footable').footable();
    $('.select2').select2({
        dropdownAutoWidth : true,
        width: 'auto'
    });
    $('#date .input-daterange').datepicker({
        format: "yyyy-mm-dd",
        todayBtn: "linked",
        keyboardNavigation: false,
        forceParse: false,
        calendarWeeks: true,
        autoclose: true
    });
    $('[type=edit]').on('click', function (event) {
            $('#p-' + event.target.dataset.id).hide();
            $('#pp-' + event.target.dataset.id).hide();
            $('#edit-' + event.target.dataset.id).hide();
            $('#cmd-' + event.target.dataset.id).show();
            $('#check-' + event.target.dataset.id).show();
            $('#delete-' + event.target.dataset.id).show();
            $('#save-' + event.target.dataset.id).show();
            $('#cancel-' + event.target.dataset.id).show();
        }
    );
    $('[type=cancel]').on('click', function (event) {
            $('#p-' + event.target.dataset.id).show();
            $('#pp-' + event.target.dataset.id).show();
            $('#edit-' + event.target.dataset.id).show();
            $('#cmd-' + event.target.dataset.id).hide();
            $('#check-' + event.target.dataset.id).hide();
            $('#delete-' + event.target.dataset.id).hide();
            $('#save-' + event.target.dataset.id).hide();
            $('#cancel-' + event.target.dataset.id).hide();
        }
    );
    $('[type=delete]').on('click', function (event) {
            console.log('are you sure to delete?');
            $('#p-' + event.target.dataset.id).show();
            $('#pp-' + event.target.dataset.id).show();
            $('#edit-' + event.target.dataset.id).show();
            $('#cmd-' + event.target.dataset.id).hide();
            $('#check-' + event.target.dataset.id).hide();
            $('#delete-' + event.target.dataset.id).hide();
            $('#save-' + event.target.dataset.id).hide();
            $('#cancel-' + event.target.dataset.id).hide();
            $.ajax({
                type: "DELETE",
                url: '/api/terminal/v2/command/blacklist/' + event.target.dataset.id + '/update/',
                success: function (result) {
                    console.log(result);
                    // Todo: alert success
                    $('#p-' + event.target.dataset.id).parent().parent().hide()
                },
                error:function (result) {
                    // Todo: alert error
                     console.log(result);
                }

            })
        }
    );
    $('[type=save]').on('click', function (event) {
            var p = $('#p-' + event.target.dataset.id);
            var pp = $('#pp-' + event.target.dataset.id);
            var cmd = $('#cmd-' + event.target.dataset.id);
            var check = $('#check-' + event.target.dataset.id);
            console.log('save!');
            p.show();
            p[0].innerHTML = cmd[0].value;
            pp.show();
            pp[0].innerHTML = check[0].checked;

            $('#edit-' + event.target.dataset.id).show();
            cmd.hide();
            check.hide();
            $('#delete-' + event.target.dataset.id).hide();
            $('#save-' + event.target.dataset.id).hide();
            $('#cancel-' + event.target.dataset.id).hide();

            $.ajax({
                type: "POST",
                contentType: 'application/json',

                url: '/api/terminal/v2/command/blacklist/' + event.target.dataset.id + '/update/',
                data: JSON.stringify({command: cmd[0].value, is_enabled: check[0].checked}),
                success: function (result) {
                    // Todo: alert success
                    console.log(result)
                },
                error: function (result) {
                    // Todo: alert error
                     console.log(result);
                }
            });
        }
    );
})
.on('click', '#btn_bulk_update', function(){
    var action = $('#slct_bulk_update').val();
    var param_action = '&action=' + action;
    var local_params = window.location.search;
    if(!local_params){
        param_action = '?action=' + action;
    }
    var params = local_params + param_action;
    var pathname = window.location.pathname + 'export/';
    var url = pathname + params;
    window.open(url);
});
</script>
{% endblock %}


